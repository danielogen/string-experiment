{% extends "base.html" %} 
{% block title %}Experiment{% endblock %} 

{% block content %}
<div class="container">
    <br>
    
    <div id="questionContainer" style="display: none;">
      <br />
      <div id="1" class="question" style="display: none;">
        <h4>Task 1 of 4: The "+" symbol represents concatenation. Press 1, 2, 3 or 4 to select the correct concatenation. </h4>
        <!-- c = 4 * 3 -->
        <!-- ("....." + a * b + ".....") -->
          <pre>
              <code>
                a = "Hello "
                b = "World"

                a + b
              </code>
          </pre>
          <!-- A. "....." + 4 * 3 + "....." -->
          <!-- B. "....." + ${4 * 3} + "....." -->
          Options: <br />
          &nbsp;&nbsp;1. "HelloWorld" <br />
          &nbsp;&nbsp;2. "Hello World" <br />
          &nbsp;&nbsp;3. "World " <br />
          &nbsp;&nbsp;4. "There" <br />
          <input type="hidden" value="1" id="category" /> <!--1. concatenation -->
          <input type="hidden" value="2" id="answer" />
          <input type="hidden" class="btn btn-success next-btn" data-next="2" />
      </div>
      <div id="2" class="question" style="display: none;">
        <h4>Task 2 of 4: The "{ }" symbol represents interpolation. Press 1, 2, 3 or 4 to select the correct interpolation.</h4>
          <pre>
            <code>
              a = "Hello "
              b = "World"

              "{b}{a}"
            </code>
        </pre>
        <!-- A. "....." + 4 * 3 + "....." -->
        <!-- B. "....." + ${4 * 3} + "....." -->
        Options: <br />
        &nbsp;&nbsp;1. "WorldHello " <br />
        &nbsp;&nbsp;2. "Hello World" <br />
        &nbsp;&nbsp;3. "World " <br />
        &nbsp;&nbsp;4. "There" <br />
      <input type="hidden" value="2" id="category" /> <!--2. interpolation -->
      <input type="hidden" value="1" id="answer" />
      <input type="hidden" class="btn btn-success next-btn" data-next="3" />
    </div>
    <div id="3" class="question" style="display: none;">
      <h4>Task 3 of 4: The "+" symbol represents concatenation. Press 1, 2, 3 or 4 to select the correct concatenation.</h4>
        <pre>
            <code>
                a = "Hi"
                b = "There"
                c = 4
                
                c + b + a
            </code>
        </pre>
        Options: <br />
        &nbsp;&nbsp;1. "Hi There 4" <br />
        &nbsp;&nbsp;2. "Hi 4 There" <br />
        &nbsp;&nbsp;3. "4 There Hi " <br />
        &nbsp;&nbsp;4. "4 Hi There" <br />
      <input type="hidden" value="1" id="category" />
      <input type="hidden" value="3" id="answer" />
      <input type="hidden" class="btn btn-success next-btn" data-next="4" />
  </div>
  <div id="4" class="question" data-next="submitPage" style="display: none;">
    <h4>Task 4 of 4: The "{ }" symbol represents interpolation. Press 1, 2, 3 or 4 to select the correct interpolation.</h4>
      <pre>
        <code>
            a = "Hi"
            b = "There"
            c = 4
            
            "{b} {a} {c}"
        </code>
    </pre>
    Options: <br />
    &nbsp;&nbsp;1. "Hi There 4" <br />
    &nbsp;&nbsp;2. "There 4 Hi" <br />
    &nbsp;&nbsp;3. "4 There Hi " <br />
    &nbsp;&nbsp;4. "There Hi 4" <br />
  <input type="hidden" value="2" id="category" />
  <input type="hidden" value="4" id="answer" />
  </div>

  <div id="submitPage" style="display: none;">
      <h4 class="text-success">Thank you for participating in this study!</h4>
      <!-- <form> -->
        <!-- Any final content or review of answers -->
        <!-- <button type="submit" class="btn btn-success">Submit</button> -->
      <!-- </form> -->
    </div>
    <!-- <p align="right">
      <br> -->
      <!-- <button type="button" class="btn btn-warning next-btn" data-next="question1">Try Again</button> -->
      <!-- <a href="{{ url_for('experiment') }}"><button type="button" class="btn btn-success next-btn" data-next="submitPage">Proceed</button></a> -->
    <!-- </p> -->
  </form>
  </div>
  
  
<!-- Bootstrap JS (optional, if you need JavaScript features) -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const questionDivs = document.querySelectorAll('.question');
    const nextButtons = document.querySelectorAll('.next-btn');
    const submitPage = document.getElementById('submitPage');
    const questionContainer = document.getElementById('questionContainer');
    let userAnswers = {};
    let startTime;
    let duration;

    function getCurrentQuestion() {
      const questions = document.querySelectorAll('.question');
      for (let i = 0; i < questions.length; i++) {
        if (questions[i].style.display !== 'none') {
          return questions[i];
        }
      }
      return null;
    }

    // Function to handle keyboard navigation
    function handleKeyboardNavigation(event) {
      const currentQuestion = getCurrentQuestion();
      if (!currentQuestion) return; // No current question found
      
      const nextButton = currentQuestion.querySelector('.next-btn');
      const questionId = currentQuestion.id;
      const userAnswer = event.key;
      const correctAnswer = currentQuestion.querySelector('#answer').value;
      const category = currentQuestion.querySelector('#category').value;

      // Check if the key pressed is a valid answer option
      if(['1', '2', '3', '4'].includes(userAnswer)) {
        // Store the user's answer and the correct answer together
        const endTime = new Date();
        duration = (endTime - startTime) / 1000; // Calculate duration in seconds
        console.log(duration);

        userAnswers[questionId] = { category, correctAnswer, userAnswer, duration };

        startTime = new Date();
        // console.log(duration)
        // userAnswers[questionId] = { userAnswer, correctAnswer };

        // Check if it's the last question
        if (currentQuestion.getAttribute('data-next') === "submitPage") {
          // Send all answers to the backend
          fetch('/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userAnswers),
          })
          .then(response => response.json())
          .then(data => {
            console.log('Success:', data);
            // Optionally, redirect the user or display a success message
            currentQuestion.style.display = 'none'
            submitPage.style.display = 'block';
            setTimeout(() => {
              window.location = "/"
            }, 3000);
          })
          .catch((error) => {
            console.error('Error:', error);
          });
        } else {
          // Proceed to the next question
          nextButton.click();
        }
      }
    }
    // Show the question container and the first question
    // questionContainer.style.display = 'block';
    // document.getElementById('question1').style.display = 'block';
    // Initialize the start time and show the first question
    setTimeout(() => {
      startTime = new Date(); // Set the start time just before displaying the first question
      questionContainer.style.display = 'block';
      document.getElementById('1').style.display = 'block';
    }, 0);

    
    nextButtons.forEach(function(button, index) {
      button.addEventListener('click', function() {

        const nextQuestionId = button.getAttribute('data-next');
        const nextQuestion = document.getElementById(nextQuestionId);

        // Hide current question
        button.closest('.question').style.display = 'none';
        if (nextQuestionId === 'submitPage'){
          submitPage.style.display = 'block';
        }else{
          nextQuestion.style.display = 'block';
        }
        
      });
    });

    // Listen for keydown events to handle keyboard navigation
    document.addEventListener('keydown', handleKeyboardNavigation);
  })
</script>
{% endblock %} 